<!-- 22ae44f7-7c21-4c5e-aaa9-a1e41463999d 80d5e2f8-ff11-441f-b879-fc2b007a2b29 -->
# Plan: Ajustes de base de datos para cubrir dominio y permisos

### Objetivos

- Soportar alcance territorial por rol (Zona/Colegio/Mesa) y transiciones.
- Adjuntar documentación a `Mesa` con metadatos, versionado simple y moderación.
- Canales de conversación por `Zona`, `Colegio` y `Mesa` con mensajes y adjuntos.
- Corregir unicidades que hoy son demasiado globales (mesas y colegios).

### Cambios propuestos en `prisma/schema.prisma`

- Normalización y claves obligatorias:
  - Hacer `Mesa.colegioId` requerido (NOT NULL) y `Colegio.zonaId` requerido, salvo que se justifique carga intermedia.
  - Mantener `Fiscal.tipoFiscalId` opcional si hay flujo de alta sin asignación inmediata.

- Unicidades y claves naturales:
  - `Mesa`: `@@unique([colegioId, numero])` en vez de `@unique(numero)` global.
  - `Colegio`: `@@unique([zonaId, nombre])` en vez de `@unique(nombre)` global (si hay nombres repetidos entre zonas).

- Relaciones de alcance explícitas:
  - `FiscalZona (fiscalId, zonaId, ...)` con `@@unique([fiscalId, zonaId])`.
  - `FiscalColegio` ya existe (mantener `@@unique([fiscalId, colegioId])`).
  - Crear unión explícita `FiscalMesa (fiscalId, mesaId, assignedAt, assignedByFiscalId?, notes?, enabled)` con `@@unique([fiscalId, mesaId])` para poder auditar asignaciones.

- Consistencia de "lugar donde vota" en `Fiscal`:
  - Mantener `colegioDondeVotaId` y `mesaDondeVotaId`.
  - Agregar CHECK: si ambos no son NULL, entonces `mesa.colegioId == colegioDondeVotaId`.

- Documentación de mesas (fotos/actas):
  - `MesaDocumento (id, mesaId, tipo enum, archivoId, autorFiscalId?, capturedAt, notes, status enum, version, timestamps, enabled)`.
  - `Archivo (id, storagePath, mimeType, sizeBytes, sha256, createdAt)` con `@unique(sha256)` para deduplicar binarios.
  - Índices: `MesaDocumento` por `(mesaId, status)`, `(mesaId, tipo, version)` único.

- Canales y mensajes (sin polimorfismo en Prisma):
  - `CanalZona/CanalColegio/CanalMesa` cada uno con FK fuerte a su entidad.
  - `...Mensaje` por cada canal con `autorFiscalId?`, `contenido`, `status`, `pinned` e índices por `(canalXId, createdAt DESC)`.
  - Adjuntos: duplicar tablas por tipo de mensaje para FKs fuertes o usar `MensajeAdjunto` con validación app-level.

- Auditoría:
  - `AuditLog (id, actorFiscalId?, action, entityType, entityId, metadata, createdAt)`; índices por `action`, `entityType`, `createdAt`.

- Reglas de borrado y cascadas:
  - `onDelete: Cascade` en tablas de unión (`FiscalZona`, `FiscalColegio`, `FiscalMesa`).
  - `MesaDocumento.archivoId` con `Restrict` para no borrar binario con referencias; garbage collector app-side.
  - Campos de "vota": `SET NULL` al borrar `Mesa` o `Colegio`.

- Soft delete y filtrado:
  - Conservar `enabled`; agregar `deletedAt DateTime?` para trazabilidad.
  - Agregar índices parciales por `enabled = 1` cuando beneficie (PostgreSQL los soporta a través de `@@index([campo], map: ...)` con raw, opcional).

- Enums Prisma para estados:
  - `enum DocumentoTipo { certificado_escrutinio acta telegrama otro }`
  - `enum ModerationStatus { pending verified rejected }`

- Índices de rendimiento:
  - `Mesa (colegioId)` ya existe; agregar `@@index([colegioId, numero])` si se busca por número.
  - `FiscalColegio (colegioId, fiscalId)` cobertura inversa.
  - `FiscalMesa (mesaId, fiscalId)` cobertura inversa.
  - `MesaDocumento (mesaId, createdAt)` para listados recientes.

- Alcances/roles operativos por fiscal:
  - Agregar tabla N:N `FiscalZona (fiscalId, zonaId, createdAt, updatedAt, enabled)` con `@@unique([fiscalId, zonaId])` e índices.
  - Mantener `FiscalColegio` (ya existe) y `Fiscal↔Mesa` (ya existe vía M:N) como asignaciones para FISCAL_GENERAL y FISCAL_MESA.

- Documentación de mesas (fotos/actas):
  - Crear `MesaDocumento` con campos: `id`, `mesaId` FK, `tipo` (string o enum), `path` (o `url`), `mimeType`, `sizeBytes`, `autorFiscalId` (FK opcional) o `autorUserId` si existiera, `capturedAt`, `notes`, `status` (pending/verified/rejected), `version` (int), timestamps, `enabled`.
  - Índices: `mesaId`, `status`, `createdAt`; `@@index([mesaId, status])`.
  - Versionado simple: `version` + `mesaId` con `@@unique([mesaId, tipo, version])`.

- Canales de conversación (elección con FK fuerte, sin polimorfismo Prisma):
  - Crear tres tablas de canal para FKs fuertes:
    - `CanalZona (id, zonaId FK, titulo?, createdAt, updatedAt, enabled)`
    - `CanalColegio (id, colegioId FK, titulo?, createdAt, updatedAt, enabled)`
    - `CanalMesa (id, mesaId FK, titulo?, createdAt, updatedAt, enabled)`
  - Para mensajes:
    - `CanalZonaMensaje (id, canalZonaId FK, autorFiscalId?, contenido, createdAt, updatedAt, status?, pinned?, enabled)`
    - `CanalColegioMensaje (id, canalColegioId FK, autorFiscalId?, contenido, createdAt, updatedAt, status?, pinned?, enabled)`
    - `CanalMesaMensaje (id, canalMesaId FK, autorFiscalId?, contenido, createdAt, updatedAt, status?, pinned?, enabled)`
  - Adjuntos de mensajes (reutilizables): `MensajeAdjunto (id, mensajeTipo, mensajeId, path/url, mimeType, sizeBytes, createdAt)`. Nota: si se prefiere FK fuerte, duplicar adjuntos por tipo (tres tablas) en vez de polimorfismo.

- Ajustes de unicidad y normalización existentes:
  - `Mesa.numero`: reemplazar `@unique` global por `@@unique([colegioId, numero])` (número único por colegio). Hoy está global:
```103:107:prisma/schema.prisma
id                  Int      @id @default(autoincrement())
colegioId           Int?
numero              String   @unique
```

  - `Colegio.nombre`: evaluar permitir repetición entre zonas, proponiendo `@@unique([zonaId, nombre])` en lugar de `@unique` global.

- Auditoría (opcional pero recomendada para transiciones de rol):
  - `AuditLog (id, actorFiscalId?, action, entityType, entityId, metadata JSON string, createdAt)` con índices por `action`, `entityType`, `createdAt`.

### Consideraciones de implementación

- No forzar validaciones complejas en Prisma cuando PostgreSQL lo resuelve con índices únicos y FKs; mantener la integridad con FKs, `@@unique` e índices.
- Moderación y límites de tamaño/tipo se validan en la aplicación; almacenar `mimeType`/`sizeBytes` ayuda a trazabilidad.
- Si más adelante se introduce `User` distinto a `Fiscal`, `MesaDocumento.autorFiscalId` puede convertirse en `autorUserId` o mantenerse ambos (uno requerido).

### Etapas ejecutables

#### Etapa 1: Normalización básica y unicidades
- Cambios BD: `Mesa.colegioId` NOT NULL; `Colegio.zonaId` NOT NULL; `@@unique([colegioId, numero])`; `@@unique([zonaId, nombre])`.
- Endpoints: sin cambios de contrato; validar que altas/edit usan IDs requeridos.
- Pruebas frontend: crear/listar Mesas por Colegio y Colegios por Zona; verificar errores si falta relación.

#### Etapa 2: Alcance territorial explícito
- Cambios BD: tablas `FiscalZona` y `FiscalMesa` (uniones con `@@unique` y cascadas). Mantener `FiscalColegio`.
- Endpoints: asignar/quitar zona/colegio/mesa a Fiscal; leer alcances de un fiscal.
- Pruebas frontend: UI mínima para asignación y lectura de alcance; validar restricciones.

#### Etapa 3: Documentación de Mesas
- Cambios BD: `Archivo` (dedupe por `sha256`), `MesaDocumento` (metadatos, `status`, `version`). Índices clave.
- Endpoints: upload (multipart) → crea `Archivo` y `MesaDocumento`; listar por mesa y por estado.
- Pruebas frontend: subir imagen dummy, ver listado y metadatos.

#### Etapa 4: Canales y Mensajes
- Cambios BD: `CanalZona/Colegio/Mesa` y `...Mensaje` (FK fuerte), índices por canal/createdAt.
- Endpoints: crear/listar mensajes por canal; marcar `pinned`.
- Pruebas frontend: UI simple de hilos por entidad; postear y leer mensajes.

#### Etapa 5: Auditoría (opcional)
- Cambios BD: `AuditLog` básico con índices.
- Endpoints: registrar en acciones críticas (asignaciones, uploads, moderación).
- Pruebas frontend: no requiere UI inmediata; verificar registros vía endpoint admin.

### Migraciones y datos

- Crear migraciones incrementales por etapa, verificando conflictos de datos.
- Poblar `TiposFiscales` ya existente; agregar seeds mínimos para canales si se desea.

### To-dos

- [ ] Agregar tabla N:N FiscalZona con índices y unique compuesta
- [ ] Crear MesaDocumento con metadatos, status y versionado simple
- [ ] Crear tablas CanalZona/Colegio/Mesa y sus Mensajes
- [ ] Cambiar unicidad de Mesa.numero y Colegio.nombre
- [ ] Agregar tabla de auditoría básica para cambios críticos